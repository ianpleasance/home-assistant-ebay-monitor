blueprint:
  name: eBay - Auction Ending Soon Alert
  description: Send a notification when an auction you're bidding on is ending soon
  domain: automation
  source_url: https://github.com/planetbuilders/ebay-integration/blueprints/automation/ebay_auction_ending_soon.yaml
  input:
    ebay_account:
      name: eBay Account
      description: Which eBay account to monitor (leave blank for all accounts)
      default: ""
      selector:
        text:
    notify_service:
      name: Notification Service
      description: The notification service to use
      selector:
        target:
    only_if_winning:
      name: Only Alert if Winning
      description: Only send notification if you're currently the high bidder
      default: false
      selector:
        boolean:
    only_if_losing:
      name: Only Alert if Losing
      description: Only send notification if you're NOT the high bidder
      default: false
      selector:
        boolean:

trigger:
  - platform: event
    event_type: ebay_auction_ending_soon

condition:
  - condition: template
    value_template: >-
      {{ !ebay_account or trigger.event.data.account == ebay_account }}
  - condition: template
    value_template: >-
      {% set is_high_bidder = trigger.event.data.item.is_high_bidder %}
      {% if only_if_winning and only_if_losing %}
        true
      {% elif only_if_winning %}
        {{ is_high_bidder }}
      {% elif only_if_losing %}
        {{ not is_high_bidder }}
      {% else %}
        true
      {% endif %}

action:
  - service: !input notify_service
    data:
      title: "â° Auction ending in {{ trigger.event.data.minutes_remaining }} minutes!"
      message: >-
        {{ trigger.event.data.item.title }}
        {% if trigger.event.data.item.is_high_bidder %}
        ğŸŸ¢ You're winning!
        {% else %}
        ğŸ”´ You're NOT winning!
        {% endif %}
        Current price: {{ trigger.event.data.item.current_price.value }} {{ trigger.event.data.item.current_price.currency }}
      data:
        url: "{{ trigger.event.data.item.item_url }}"
        tag: "ebay_ending_{{ trigger.event.data.item.item_id }}"
        image: "{{ trigger.event.data.item.image_url }}"
        actions:
          - action: "URI"
            title: "View on eBay"
            uri: "{{ trigger.event.data.item.item_url }}"
